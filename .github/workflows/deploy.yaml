name: Deploy to gametrix server
on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.11.0'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Debug secrets (remove this step after testing)
        run: |
          echo "Testing if secrets are accessible:"
          echo "APP_PORT is set: ${{ secrets.APP_PORT != '' }}"
          echo "DATABASE_URL is set: ${{ secrets.DATABASE_URL != '' }}"

      - name: Create .env file
        run: |
          cat > .env << EOF
          # App Configuration
          APP_PORT=${{ secrets.APP_PORT }}
          APP_URL=${{ secrets.APP_URL }}
          NODE_ENVIRONMENT=production
          NODE_VERSION=20.11.0
          CORS_ALLOWED_ORIGINS=${{ secrets.CORS_ALLOWED_ORIGINS }}
          FRONTEND_APP_URL=${{ secrets.FRONTEND_APP_URL }}
          
          # Database Configuration
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB=${{ secrets.POSTGRES_DB }}
          POSTGRES_HOST=${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT=${{ secrets.POSTGRES_PORT }}
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          
          # JWT Configuration
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_TOKEN_AUDIENCE=${{ secrets.JWT_TOKEN_AUDIENCE }}
          JWT_TOKEN_ISSUER=${{ secrets.JWT_TOKEN_ISSUER }}
          JWT_ACCESS_TOKEN_TTL=${{ secrets.JWT_ACCESS_TOKEN_TTL }}
          
          # Redis Configuration
          REDIS_PORT=${{ secrets.REDIS_PORT }}
          REDIS_URL=${{ secrets.REDIS_URL }}
          
          # Mail Configuration
          MAIL_HOST=${{ secrets.MAIL_HOST }}
          MAIL_PORT=${{ secrets.MAIL_PORT }}
          MAIL_SECURE=${{ secrets.MAIL_SECURE }}
          MAIL_USER=${{ secrets.MAIL_USER }}
          MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}
          
          # LiveKit Configuration
          LIVEKIT_URL=${{ secrets.LIVEKIT_URL }}
          LIVEKIT_API_KEY=${{ secrets.LIVEKIT_API_KEY }}
          LIVEKIT_API_SECRET=${{ secrets.LIVEKIT_API_SECRET }}
          EOF

      - name: Generate Prisma Client
        run: pnpm prisma generate

      - name: Run database migrations
        run: pnpm prisma migrate deploy
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Build application
        run: pnpm run build

      - name: Create logs directory
        run: mkdir -p logs

      - name: Stop existing PM2 processes
        run: |
          pm2 stop lynx-backend || true
          pm2 delete lynx-backend || true

      - name: Start application with PM2
        run: |
          pm2 start ecosystem.config.js --env production
          pm2 save
          pm2 startup || true

      - name: Health check
        run: |
          sleep 10
          pm2 status
          curl -f http://localhost:${{ secrets.APP_PORT }}/health || curl -f http://localhost:${{ secrets.APP_PORT }} || echo "Health check failed, but deployment completed"

      - name: Cleanup old PM2 logs
        run: |
          pm2 flush || true
          find ./logs -name "*.log" -mtime +7 -delete || true

      - name: Display deployment status
        run: |
          echo "ðŸš€ Deployment completed successfully!"
          echo "Application: lynx-backend"
          echo "Environment: production"
          echo "Port: ${{ secrets.APP_PORT }}"
          pm2 list
